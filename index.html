<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pocket Cast Stats</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  </head>
  <body>
    <main class="m-3">
      <h1 class="title">Pocket Cast Stats</h1>
      <div>
        <p id="today"></p>
        <p id="yesterday"></p>
        <p id="twoDaysAgo"></p>
      </div>
    </main>

    <script>
      (() => {
        const pocketCasts = {
          dateString: (daysAgo = 0) => {
            const [month, day, year] = (new Date(Date.now() - (daysAgo * 24) * 3600 * 1000))
              .toLocaleString("en-US", { timeZone: "America/Chicago", year: "numeric", month: "2-digit", day: "2-digit" })
              .split("/");
            return `${year}-${month}-${day}`;
          },
          statsUrl: (daysAgo = 0) => {
            return `https://raw.githubusercontent.com/jhunschejones/Pocket-Casts-Stats/main/stats/${pocketCasts.dateString(daysAgo)}`;
          },
          todayStatsUrl: () => pocketCasts.statsUrl(),
          yesterdayStatsUrl: () => pocketCasts.statsUrl(1),
          twoDaysAgoStatsUrl: () => pocketCasts.statsUrl(2),
          threeDaysAgoStatsUrl: () => pocketCasts.statsUrl(3),
          updateTotals: async () => {
            const responses = await Promise.all([
              fetch(pocketCasts.todayStatsUrl()),
              fetch(pocketCasts.yesterdayStatsUrl()),
              fetch(pocketCasts.twoDaysAgoStatsUrl()),
              fetch(pocketCasts.threeDaysAgoStatsUrl())
            ]);

            const [
              todayTotal,
              yesterdayTotal,
              twoDaysAgoTotal,
              threeDaysAgoTotal,
            ] = await Promise.all(
              responses.map(async (response) => {
                if (!response.ok) {
                  return 0;
                }
                const total = await response.text();
                return parseInt(total);
              })
            );

            const todayMinutes = Math.floor((todayTotal - yesterdayTotal) / 60);
            document.querySelector("#today").textContent = `${pocketCasts.dateString()}: ${todayMinutes} minutes`;

            const yesterdayMinutes = Math.floor((yesterdayTotal - twoDaysAgoTotal) / 60);
            document.querySelector("#yesterday").textContent = `${pocketCasts.dateString(1)}: ${yesterdayMinutes} minutes`;

            const twoDaysAgoMinutes = Math.floor((twoDaysAgoTotal - threeDaysAgoTotal) / 60);
            document.querySelector("#twoDaysAgo").textContent = `${pocketCasts.dateString(2)}: ${twoDaysAgoMinutes} minutes`;
          }
        }

        document.addEventListener("DOMContentLoaded", () => pocketCasts.updateTotals());
      })();
    </script>
  </body>
</html>
